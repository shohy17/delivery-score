<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>é…é”å˜ä¾¡ãƒã‚§ãƒƒã‚«ãƒ¼</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Space+Mono:wght@400;700&display=swap');

:root {
  --bg:#0a0f0d; --bg2:#0f1611;
  --surface:#131a15; --surface2:#1a2420; --surface3:#1f2e28;
  --border:#1e3028; --border2:#243d33;
  --accent:#00e676; --accent2:#00bfa5;
  --accent-dim:rgba(0,230,118,0.12); --accent-glow:rgba(0,230,118,0.25);
  --yellow:#ffc107; --red:#ff5252; --blue:#29b6f6;
  --text:#e0efe8; --text2:#8aab98; --text3:#4d7060;
  --uber-color:#06c167; --rocket-color:#ff6b35;
  --r:16px; --r-sm:10px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:84px;overflow-x:hidden;}

/* BG */
.bg-glow{position:fixed;top:-200px;left:50%;transform:translateX(-50%);width:600px;height:400px;background:radial-gradient(ellipse,rgba(0,230,118,0.06) 0%,transparent 70%);pointer-events:none;z-index:0;}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;z-index:100;background:rgba(10,15,13,0.96);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;padding-bottom:env(safe-area-inset-bottom,0);}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;padding:10px 4px 8px;border:none;background:transparent;color:var(--text3);cursor:pointer;font-family:inherit;font-size:10px;font-weight:500;gap:4px;transition:color .2s;}
.nav-btn.active{color:var(--accent);}
.nav-icon{font-size:20px;line-height:1;}

/* â”€â”€ PAGES â”€â”€ */
.page{display:none;position:relative;z-index:1;}
.page.active{display:block;}

/* â”€â”€ PLATFORM SELECTOR â”€â”€ */
.platform-bar{
  display:flex;align-items:center;gap:10px;
  padding:12px 16px;
  background:var(--surface);
  border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:50;
  backdrop-filter:blur(12px);
}
.platform-label{font-size:11px;color:var(--text3);font-weight:700;white-space:nowrap;}
.platform-toggle{
  display:flex;background:var(--surface2);border:1px solid var(--border);
  border-radius:30px;padding:3px;gap:2px;flex:1;
}
.platform-btn{
  flex:1;padding:7px 10px;border:none;border-radius:24px;
  font-size:12px;font-weight:700;font-family:inherit;cursor:pointer;
  transition:all .2s;color:var(--text3);background:transparent;
  display:flex;align-items:center;justify-content:center;gap:5px;
}
.platform-btn.active-uber{background:var(--uber-color);color:#fff;}
.platform-btn.active-rocket{background:var(--rocket-color);color:#fff;}
.platform-btn:not(.active-uber):not(.active-rocket):hover{color:var(--text2);}

/* â”€â”€ HOME HEADER â”€â”€ */
.home-header{padding:24px 20px 16px;text-align:center;background:linear-gradient(180deg,rgba(0,230,118,0.04) 0%,transparent 100%);}
.app-icon{width:64px;height:64px;border-radius:18px;background:linear-gradient(135deg,#0d2e1e,#1a4a2e);border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 12px;box-shadow:0 0 30px rgba(0,230,118,0.15);}
.app-name{font-size:20px;font-weight:900;letter-spacing:-0.5px;}
.app-sub{font-size:11px;color:var(--text2);margin-top:3px;}

/* â”€â”€ SALES CARD â”€â”€ */
.sales-card{margin:0 16px 14px;background:linear-gradient(135deg,#0d2a1c,#0f3524);border:1px solid var(--border2);border-radius:var(--r);padding:18px;position:relative;overflow:hidden;transition:border-color .3s;}
.sales-card.platform-uber{border-color:rgba(6,193,103,0.4);}
.sales-card.platform-rocket{border-color:rgba(255,107,53,0.4);}
.sales-card::before{content:'';position:absolute;top:-40px;right:-40px;width:150px;height:150px;background:radial-gradient(circle,rgba(0,230,118,0.1),transparent 70%);}
.sales-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.sales-tag{display:flex;align-items:center;gap:6px;font-size:13px;font-weight:700;color:var(--text2);}
.sales-tag-icon{width:24px;height:24px;border-radius:6px;background:var(--accent-dim);border:1px solid rgba(0,230,118,0.3);display:flex;align-items:center;justify-content:center;font-size:12px;}
.analysis-count{font-size:12px;color:var(--text3);}
.sales-amount-label{font-size:11px;color:var(--text2);margin-bottom:3px;}
.sales-amount{font-family:'Space Mono',monospace;font-size:38px;font-weight:700;color:var(--accent);letter-spacing:-1px;}

/* â”€â”€ FILTER ROW (history/report) â”€â”€ */
.filter-bar{
  display:flex;gap:6px;padding:10px 16px;
  border-bottom:1px solid var(--border);
  overflow-x:auto;scrollbar-width:none;
}
.filter-bar::-webkit-scrollbar{display:none;}
.filter-chip{
  padding:6px 14px;border-radius:20px;border:1px solid var(--border2);
  background:var(--surface2);color:var(--text3);
  font-size:12px;font-weight:700;font-family:inherit;cursor:pointer;
  white-space:nowrap;transition:all .2s;
}
.filter-chip.active{background:var(--accent);color:#0a0f0d;border-color:var(--accent);}
.filter-chip.chip-uber.active{background:var(--uber-color);border-color:var(--uber-color);color:#fff;}
.filter-chip.chip-rocket.active{background:var(--rocket-color);border-color:var(--rocket-color);color:#fff;}

/* â”€â”€ STATS GRIDS â”€â”€ */
.section-label{font-size:11px;color:var(--text3);font-weight:700;letter-spacing:1px;margin:12px 0 8px;}
.stats-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.stats-grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:7px;margin-top:8px;}
.stat-item{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r-sm);padding:11px 6px;text-align:center;}
.stat-icon{width:32px;height:32px;border-radius:9px;background:var(--accent-dim);border:1px solid rgba(0,230,118,0.2);display:flex;align-items:center;justify-content:center;font-size:14px;margin:0 auto 5px;}
.stat-label{font-size:9px;color:var(--text3);margin-bottom:2px;font-weight:500;}
.stat-value{font-size:12px;font-weight:900;color:var(--text);}
.stat-value.accent{color:var(--accent);}

/* â”€â”€ PLATFORM BADGES â”€â”€ */
.badge{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;}
.badge-uber{background:rgba(6,193,103,0.15);color:var(--uber-color);border:1px solid rgba(6,193,103,0.3);}
.badge-rocket{background:rgba(255,107,53,0.15);color:var(--rocket-color);border:1px solid rgba(255,107,53,0.3);}
.badge-all{background:var(--accent-dim);color:var(--accent);border:1px solid rgba(0,230,118,0.3);}

/* â”€â”€ OCR SECTION â”€â”€ */
.ocr-section{margin:14px 16px 0;}
.auto-save-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);font-size:14px;color:var(--text2);}
.toggle{width:46px;height:26px;background:var(--surface3);border-radius:13px;position:relative;cursor:pointer;border:1px solid var(--border2);transition:background .2s;}
.toggle.on{background:var(--accent);}
.toggle-thumb{position:absolute;top:3px;left:3px;width:20px;height:20px;background:#fff;border-radius:50%;transition:left .2s;}
.toggle.on .toggle-thumb{left:23px;}

.upload-zone{border:1.5px dashed var(--border2);border-radius:var(--r);padding:28px 20px;text-align:center;cursor:pointer;transition:all .2s;margin:10px 0;position:relative;overflow:hidden;}
.upload-zone:hover,.upload-zone.drag{border-color:var(--accent);background:var(--accent-dim);}
.upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.upload-icon{width:48px;height:48px;border-radius:14px;background:var(--surface3);display:flex;align-items:center;justify-content:center;font-size:20px;margin:0 auto 10px;}
.upload-title{font-size:14px;font-weight:700;margin-bottom:3px;}
.upload-sub{font-size:11px;color:var(--text3);}

/* OCR PLATFORM HINT */
.ocr-platform-hint{
  display:flex;align-items:center;gap:8px;padding:9px 12px;
  border-radius:var(--r-sm);margin-bottom:8px;font-size:12px;font-weight:600;
  transition:all .3s;
}
.ocr-platform-hint.hint-uber{background:rgba(6,193,103,0.1);border:1px solid rgba(6,193,103,0.25);color:var(--uber-color);}
.ocr-platform-hint.hint-rocket{background:rgba(255,107,53,0.1);border:1px solid rgba(255,107,53,0.25);color:var(--rocket-color);}

.analyze-btn{width:100%;padding:16px;border:none;border-radius:var(--r);background:var(--accent);color:#0a0f0d;font-size:15px;font-weight:900;font-family:inherit;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:4px;}
.analyze-btn:active{transform:scale(0.98);opacity:.9;}

/* OCR PREVIEW */
.ocr-preview{background:var(--surface2);border:1px solid var(--border2);border-radius:var(--r-sm);padding:13px;margin:8px 0;display:none;}
.ocr-preview.show{display:block;}
.ocr-preview-title{font-size:11px;color:var(--text3);margin-bottom:8px;font-weight:700;}
.ocr-field{display:flex;justify-content:space-between;align-items:center;padding:5px 0;font-size:13px;border-bottom:1px solid var(--border);}
.ocr-field:last-child{border-bottom:none;}
.ocr-field-label{color:var(--text3);}
.ocr-field-input{background:transparent;border:none;outline:none;color:var(--accent);font-weight:700;font-family:'Space Mono',monospace;font-size:13px;text-align:right;width:120px;}

/* â”€â”€ HISTORY â”€â”€ */
.page-header{padding:16px 16px 12px;font-size:18px;font-weight:900;border-bottom:1px solid var(--border);}
.history-item{padding:13px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.history-left{flex:1;min-width:0;}
.history-date{font-size:13px;font-weight:700;margin-bottom:3px;display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.history-meta{font-size:11px;color:var(--text3);}
.history-right{text-align:right;flex-shrink:0;}
.history-sales{font-size:15px;font-weight:900;color:var(--accent);}
.history-hourly{font-size:10px;color:var(--text3);margin-top:1px;}
.history-delete{padding:4px 8px;border:1px solid rgba(255,82,82,0.3);border-radius:6px;background:rgba(255,82,82,0.08);color:var(--red);font-size:10px;cursor:pointer;font-family:inherit;flex-shrink:0;}

.empty-state{padding:50px 20px;text-align:center;color:var(--text3);}
.empty-icon{font-size:44px;margin-bottom:10px;}
.empty-text{font-size:14px;font-weight:700;color:var(--text2);}
.empty-sub{font-size:12px;margin-top:5px;}

/* â”€â”€ REPORT â”€â”€ */
.report-header{padding:16px 16px 0;display:flex;align-items:center;justify-content:space-between;}
.report-title{font-size:18px;font-weight:900;}
.perf-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 16px;}
.perf-item{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r-sm);padding:13px;}
.perf-label{font-size:10px;color:var(--text3);margin-bottom:4px;display:flex;align-items:center;gap:4px;}
.perf-value{font-size:18px;font-weight:900;}
.perf-unit{font-size:10px;color:var(--text3);margin-left:2px;}

.advice-card{margin:0 16px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:15px;}
.advice-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.advice-title{font-size:14px;font-weight:700;}
.ai-badge{display:flex;align-items:center;gap:5px;padding:5px 10px;border:1px solid rgba(255,193,7,0.4);border-radius:20px;background:rgba(255,193,7,0.08);font-size:11px;font-weight:700;color:var(--yellow);cursor:pointer;transition:all .2s;}
.ai-badge:active{transform:scale(0.96);}
.advice-item{display:flex;align-items:flex-start;gap:10px;padding:7px 0;border-bottom:1px solid var(--border);font-size:13px;line-height:1.6;}
.advice-item:last-child{border-bottom:none;}
.advice-icon{font-size:15px;flex-shrink:0;margin-top:1px;}
.ai-thinking{text-align:center;padding:16px;color:var(--text3);font-size:13px;display:none;}
.ai-thinking.show{display:block;}

.compare-section{margin:0 16px 14px;}
.compare-title{font-size:13px;font-weight:700;color:var(--text2);margin-bottom:8px;}
.compare-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.compare-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r-sm);padding:13px;}
.compare-card.best{border-color:rgba(255,193,7,0.3);}
.compare-header{display:flex;align-items:center;gap:5px;font-size:12px;font-weight:700;margin-bottom:9px;color:var(--text2);}
.compare-badge{width:20px;height:20px;border-radius:5px;background:var(--surface3);display:flex;align-items:center;justify-content:center;font-size:10px;}
.compare-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;}
.compare-label{font-size:10px;color:var(--text3);}
.compare-val{font-size:12px;font-weight:700;display:flex;align-items:center;gap:2px;}
.trend-up{color:var(--accent);font-size:10px;}

/* â”€â”€ SETTINGS â”€â”€ */
.settings-header{padding:16px 16px 12px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);}
.back-btn{color:var(--text2);font-size:20px;cursor:pointer;line-height:1;}
.settings-title{font-size:18px;font-weight:900;}
.settings-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);margin:12px 16px;padding:15px;}
.settings-section-title{font-size:13px;font-weight:700;margin-bottom:12px;}
.account-row{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
.account-avatar{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--accent-dim),var(--surface3));border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:18px;}
.account-name{font-size:14px;font-weight:700;}
.account-email{font-size:11px;color:var(--text3);margin-top:1px;}
.logout-btn{width:100%;padding:11px;border:1px solid rgba(255,82,82,0.3);border-radius:var(--r-sm);background:rgba(255,82,82,0.06);color:var(--red);font-size:13px;font-weight:700;font-family:inherit;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;}
.feature-item{display:flex;align-items:center;gap:8px;padding:5px 0;font-size:13px;}
.feature-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);flex-shrink:0;}
.info-row{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border);font-size:13px;}
.info-row:last-child{border-bottom:none;}
.info-label{color:var(--text3);}
.info-value{font-weight:700;font-family:'Space Mono',monospace;font-size:11px;}
.disclaimer{margin:12px 16px;padding:11px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;color:var(--text3);line-height:1.7;display:flex;gap:8px;align-items:flex-start;}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.75);align-items:flex-end;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--r) var(--r) 0 0;padding:22px 16px 40px;width:100%;max-height:82vh;overflow-y:auto;animation:slideUp .25s ease;}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.modal-title{font-size:16px;font-weight:900;margin-bottom:14px;}
.modal-form-group{margin-bottom:11px;}
.modal-label{font-size:11px;color:var(--text3);font-weight:700;margin-bottom:4px;display:block;}
.modal-input{width:100%;padding:11px 13px;background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--r-sm);color:var(--text);font-size:14px;font-family:inherit;outline:none;appearance:none;}
.modal-input:focus{border-color:var(--accent);}
.modal-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px;}
.modal-btn{padding:13px;border:none;border-radius:var(--r-sm);font-size:14px;font-weight:700;font-family:inherit;cursor:pointer;}
.modal-btn-primary{background:var(--accent);color:#0a0f0d;}
.modal-btn-cancel{background:var(--surface2);color:var(--text2);border:1px solid var(--border);}

/* â”€â”€ LOADING / TOAST â”€â”€ */
.loading-overlay{display:none;position:fixed;inset:0;z-index:200;background:rgba(10,15,13,0.88);backdrop-filter:blur(4px);align-items:center;justify-content:center;flex-direction:column;gap:14px;}
.loading-overlay.show{display:flex;}
.spinner{width:44px;height:44px;border:3px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loading-text{font-size:13px;font-weight:700;color:var(--text2);}
.toast{position:fixed;bottom:92px;left:50%;transform:translateX(-50%);background:var(--accent);color:#0a0f0d;padding:10px 22px;border-radius:30px;font-size:13px;font-weight:700;opacity:0;transition:opacity .3s;z-index:300;white-space:nowrap;pointer-events:none;}
.toast.show{opacity:1;}

/* â”€â”€ INCOME SUPPORT BANNER â”€â”€ */
.income-banner{
  margin:0 16px 16px;
  background:linear-gradient(160deg,#0b1f14 0%,#0d2a1a 100%);
  border:1px solid rgba(0,230,118,0.2);
  border-radius:var(--r);
  padding:16px;
  position:relative;overflow:hidden;
}
.income-banner::before{
  content:'';position:absolute;top:-30px;right:-30px;
  width:120px;height:120px;
  background:radial-gradient(circle,rgba(0,230,118,0.08),transparent 70%);
  pointer-events:none;
}
.income-banner-header{
  display:flex;align-items:center;gap:8px;margin-bottom:4px;
}
.income-banner-icon{
  width:28px;height:28px;border-radius:8px;
  background:rgba(0,230,118,0.12);
  border:1px solid rgba(0,230,118,0.25);
  display:flex;align-items:center;justify-content:center;
  font-size:14px;flex-shrink:0;
}
.income-banner-title{font-size:14px;font-weight:900;letter-spacing:-0.2px;}
.income-banner-sub{font-size:11px;color:var(--text3);margin-bottom:14px;margin-left:36px;}

/* CTAãƒœã‚¿ãƒ³å…±é€š */
.income-cta{
  display:flex;align-items:center;
  width:100%;border:none;border-radius:12px;
  padding:13px 14px;margin-bottom:9px;
  cursor:pointer;font-family:inherit;
  text-decoration:none;
  transition:transform .15s,filter .15s;
  position:relative;overflow:hidden;
}
.income-cta:last-child{margin-bottom:0;}
.income-cta:active{transform:scale(0.98);filter:brightness(0.92);}
.income-cta-icon{
  width:34px;height:34px;border-radius:9px;
  background:rgba(255,255,255,0.12);
  display:flex;align-items:center;justify-content:center;
  font-size:16px;flex-shrink:0;margin-right:11px;
}
.income-cta-body{flex:1;text-align:left;}
.income-cta-label{font-size:13px;font-weight:900;color:#fff;line-height:1.2;}
.income-cta-desc{font-size:10px;color:rgba(255,255,255,0.65);margin-top:2px;}
.income-cta-arrow{
  font-size:16px;color:rgba(255,255,255,0.5);
  flex-shrink:0;margin-left:6px;
  transition:transform .15s;
}
.income-cta:hover .income-cta-arrow{transform:translateX(3px);}

/* å€‹åˆ¥ã‚«ãƒ©ãƒ¼ */
.income-cta-rocket{
  background:linear-gradient(135deg,#1a3a6e 0%,#0d2456 100%);
  border:1px solid rgba(100,160,255,0.25);
  box-shadow:0 2px 14px rgba(41,91,255,0.15);
}
.income-cta-uber{
  background:linear-gradient(135deg,#0d3d20 0%,#0a2e18 100%);
  border:1px solid rgba(0,230,118,0.3);
  box-shadow:0 2px 14px rgba(0,230,118,0.1);
}

/* Tipsè¦ªã‚«ãƒ¼ãƒ‰ */
.income-tips-card{
  background:linear-gradient(135deg,#2e1200 0%,#1e0d00 100%);
  border:1px solid rgba(255,140,0,0.25);
  border-radius:12px;padding:12px;
  box-shadow:0 2px 14px rgba(255,100,0,0.08);
}
.income-tips-header{
  display:flex;align-items:center;gap:8px;margin-bottom:10px;
}
.income-tips-icon{font-size:16px;}
.income-tips-title{font-size:12px;font-weight:900;color:#ffb74d;}
.income-tips-desc{font-size:10px;color:rgba(255,183,77,0.65);margin-left:auto;}
.income-tips-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.income-tips-btn{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:10px 8px;border-radius:9px;
  background:rgba(255,140,0,0.12);
  border:1px solid rgba(255,140,0,0.25);
  cursor:pointer;text-decoration:none;
  transition:all .15s;
}
.income-tips-btn:active{transform:scale(0.97);background:rgba(255,140,0,0.2);}
.income-tips-btn-icon{font-size:18px;margin-bottom:4px;}
.income-tips-btn-name{font-size:11px;font-weight:700;color:#ffb74d;margin-bottom:1px;}
.income-tips-btn-sub{font-size:9px;color:rgba(255,183,77,0.55);}

/* â”€â”€ PLATFORM BREAKDOWN in stats â”€â”€ */
.platform-breakdown{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:0 16px 14px;}
.pb-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r-sm);padding:12px;}
.pb-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.pb-title{font-size:11px;font-weight:700;}
.pb-days{font-size:10px;color:var(--text3);}
.pb-sales{font-size:16px;font-weight:900;color:var(--accent);}
.pb-meta{font-size:10px;color:var(--text3);margin-top:2px;}

@media(min-width:400px){.sales-amount{font-size:44px;}}

/* â”€â”€ 3-STEP LOADING â”€â”€ */
.loading-steps{display:flex;gap:10px;margin-top:8px;}
.step-dot{width:8px;height:8px;border-radius:50%;background:var(--border2);transition:all .3s;}
.step-dot.active{background:var(--accent);box-shadow:0 0 8px var(--accent);}
.step-dot.done{background:var(--accent2);}
.loading-progress-bar{width:160px;height:4px;background:var(--border2);border-radius:2px;margin-top:8px;overflow:hidden;}
.loading-progress-fill{height:100%;background:var(--accent);transition:width .4s;width:0;}

/* â”€â”€ CONFIDENCE BADGE â”€â”€ */
.conf-badge{display:inline-flex;align-items:center;padding:1px 7px;border-radius:10px;font-size:9px;font-weight:700;margin-left:4px;vertical-align:middle;}
.conf-badge.high{background:rgba(0,230,118,0.15);color:var(--accent);border:1px solid rgba(0,230,118,0.3);}
.conf-badge.mid{background:rgba(255,193,7,0.15);color:var(--yellow);border:1px solid rgba(255,193,7,0.3);}
.conf-badge.low{background:rgba(255,82,82,0.15);color:var(--red);border:1px solid rgba(255,82,82,0.3);}

/* â”€â”€ CANDIDATE BUTTONS â”€â”€ */
.candidate-row{display:flex;gap:4px;flex-wrap:wrap;padding:2px 0 4px;border-bottom:1px solid var(--border);}
.candidate-row:empty{display:none;}
.candidate-btn{padding:2px 8px;border:1px solid var(--border2);border-radius:10px;background:var(--surface2);color:var(--text2);font-size:11px;cursor:pointer;font-family:inherit;transition:all .15s;}
.candidate-btn.selected,.candidate-btn:active{background:var(--accent);color:#0a0f0d;border-color:var(--accent);}

/* â”€â”€ RANKING PAGE â”€â”€ */
.rank-item{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r-sm);padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;gap:12px;}
.rank-pos{width:32px;height:32px;border-radius:8px;background:var(--surface3);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:900;flex-shrink:0;}
.rank-pos.top1{background:linear-gradient(135deg,#ffd700,#ffed4e);color:#1a1a23;box-shadow:0 2px 12px rgba(255,215,0,0.4);}
.rank-pos.top2{background:linear-gradient(135deg,#c0c0c0,#e8e8e8);color:#1a1a23;}
.rank-pos.top3{background:linear-gradient(135deg,#cd7f32,#e8a87c);color:#1a1a23;}
.rank-user{flex:1;min-width:0;}
.rank-name{font-size:13px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.rank-area{font-size:10px;color:var(--text3);margin-top:1px;}
.rank-stat{text-align:right;flex-shrink:0;}
.rank-val{font-size:16px;font-weight:900;color:var(--accent);}
.rank-label{font-size:9px;color:var(--text3);margin-top:1px;}
.rank-tabs{display:flex;gap:6px;padding:10px 16px 8px;border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none;}
.rank-tabs::-webkit-scrollbar{display:none;}
.rank-tab{padding:6px 12px;border-radius:20px;border:1px solid var(--border2);background:var(--surface2);color:var(--text3);font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;transition:all .2s;}
.rank-tab.active{background:var(--accent);color:#0a0f0d;border-color:var(--accent);}

/* â”€â”€ LOGIN / AUTH â”€â”€ */
.auth-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);margin:12px 16px;padding:15px;}
.auth-logged-in{display:none;}
.auth-logged-in.show{display:block;}
.auth-logged-out{display:none;}
.auth-logged-out.show{display:block;}
.login-btn{width:100%;padding:13px;border:none;border-radius:var(--r-sm);background:linear-gradient(135deg,#4285f4,#34a853);color:#fff;font-size:14px;font-weight:700;font-family:inherit;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;}
.login-btn:active{transform:scale(0.98);opacity:.9;}
.user-stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;}
.user-stat-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r-sm);padding:11px;text-align:center;}
.user-stat-label{font-size:10px;color:var(--text3);margin-bottom:3px;}
.user-stat-value{font-size:16px;font-weight:900;color:var(--accent);}
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="bg-glow"></div>

<!-- ===== HOME ===== -->
<div id="page-home" class="page active">

  <!-- Platform Selector -->
  <div class="platform-bar">
    <span class="platform-label">ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </span>
    <div class="platform-toggle">
      <button class="platform-btn" id="pb-uber"   onclick="selectPlatform('uber')">ğŸŸ¢ Uber Eats</button>
      <button class="platform-btn" id="pb-rocket" onclick="selectPlatform('rocketnow')">ğŸŸ  RocketNow</button>
    </div>
  </div>

  <div class="home-header">
    <div class="app-icon">ğŸ“¦</div>
    <div class="app-name">é…é”å˜ä¾¡ãƒã‚§ãƒƒã‚«ãƒ¼</div>
    <div class="app-sub">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‹ã‚‰å£²ä¸Šãƒ»è·é›¢ãƒ»æ™‚é–“ã‚’è‡ªå‹•è§£æ</div>
  </div>

  <!-- Sales Dashboard -->
  <div class="sales-card" id="home-sales-card">
    <div class="sales-header">
      <div class="sales-tag">
        <div class="sales-tag-icon">ğŸ“…</div>
        æœ¬æ—¥ã®çµæœ
      </div>
      <div class="analysis-count" id="analysis-count">â€” ä»¶ã®è§£æ</div>
    </div>
    <div class="sales-amount-label">ä»Šæ—¥ã®å£²ä¸Šåˆè¨ˆ</div>
    <div class="sales-amount" id="home-sales">Â¥0</div>

    <div class="section-label">é›†è¨ˆãƒ‡ãƒ¼ã‚¿</div>
    <div class="stats-grid-3">
      <div class="stat-item">
        <div class="stat-icon">ğŸ“¦</div>
        <div class="stat-label">é…é”ä»¶æ•°</div>
        <div class="stat-value" id="h-count">0ä»¶</div>
      </div>
      <div class="stat-item">
        <div class="stat-icon">ğŸ“</div>
        <div class="stat-label">ç·è·é›¢</div>
        <div class="stat-value" id="h-dist">0km</div>
      </div>
      <div class="stat-item">
        <div class="stat-icon">ğŸ•</div>
        <div class="stat-label">ç¨¼åƒæ™‚é–“</div>
        <div class="stat-value" id="h-hours">0h</div>
      </div>
    </div>
    <div class="section-label">åŠ¹ç‡æŒ‡æ¨™</div>
    <div class="stats-grid-4">
      <div class="stat-item">
        <div class="stat-icon">â±</div>
        <div class="stat-label">æ™‚çµ¦</div>
        <div class="stat-value accent" id="h-hourly">Â¥â€”</div>
      </div>
      <div class="stat-item">
        <div class="stat-icon">ğŸ</div>
        <div class="stat-label">å††/km</div>
        <div class="stat-value" id="h-kmprice">Â¥â€”</div>
      </div>
      <div class="stat-item">
        <div class="stat-icon">ğŸ§¾</div>
        <div class="stat-label">å¹³å‡å˜ä¾¡</div>
        <div class="stat-value" id="h-unit">Â¥â€”</div>
      </div>
      <div class="stat-item">
        <div class="stat-icon">âš¡</div>
        <div class="stat-label">km/h</div>
        <div class="stat-value" id="h-speed">â€”</div>
      </div>
    </div>
  </div>

  <!-- ===== åå…¥ã‚¢ãƒƒãƒ—ã‚µãƒãƒ¼ãƒˆ ãƒãƒŠãƒ¼ ===== -->
  <div class="income-banner" id="income-support-banner">
    <div class="income-banner-header">
      <div class="income-banner-icon">âš¡</div>
      <div class="income-banner-title">åå…¥ã‚¢ãƒƒãƒ—ã‚µãƒãƒ¼ãƒˆ</div>
    </div>
    <div class="income-banner-sub">é…é”ã‚’å§‹ã‚ã‚‹ / åå…¥æºã‚’å¢—ã‚„ã™</div>

    <!-- CTA 1: RocketNow -->
    <a class="income-cta income-cta-rocket"
       href="https://rocketnowdriver.app.link/W0BUMKWXP0b"
       target="_blank" rel="noopener noreferrer"
       onclick="trackIncomeCta('rocketnow')">
      <div class="income-cta-icon">ğŸš€</div>
      <div class="income-cta-body">
        <div class="income-cta-label">RocketNowã§é…é”ã‚’å§‹ã‚ã‚‹</div>
        <div class="income-cta-desc">ç´¹ä»‹ç‰¹å…¸ã‚ã‚Š Â· ã™ãã«ç¨¼ã’ã‚‹</div>
      </div>
      <span class="income-cta-arrow">â€º</span>
    </a>

    <!-- CTA 2: Uber Eats -->
    <a class="income-cta income-cta-uber"
       href="https://www.uber.com/signup/drive/deliver/?invite_code=mqgntmf"
       target="_blank" rel="noopener noreferrer"
       onclick="trackIncomeCta('uber')">
      <div class="income-cta-icon">ğŸŸ¢</div>
      <div class="income-cta-body">
        <div class="income-cta-label">Uberã§é…é”ã‚’å§‹ã‚ã‚‹</div>
        <div class="income-cta-desc">ç´¹ä»‹ç‰¹å…¸ã‚ã‚Š Â· å¥½ããªæ™‚é–“ã«ç¨¼åƒ</div>
      </div>
      <span class="income-cta-arrow">â€º</span>
    </a>

    <!-- CTA 3: Tipsï¼ˆ2ãƒªãƒ³ã‚¯ï¼‰ -->
    <div class="income-tips-card">
      <div class="income-tips-header">
        <span class="income-tips-icon">ğŸ“š</span>
        <span class="income-tips-title">é…é”ï¼‹å‰¯æ¥­ã§åå…¥ã‚’ä¼¸ã°ã™</span>
        <span class="income-tips-desc">ãŠã™ã™ã‚</span>
      </div>
      <div class="income-tips-row">
        <a class="income-tips-btn"
           href="https://tqv.jp/u/hukugyootaku/a/0fFlxtwI/BaID7R6d"
           target="_blank" rel="noopener noreferrer"
           onclick="trackIncomeCta('tips_nyafu')">
          <div class="income-tips-btn-icon">ğŸ’¡</div>
          <div class="income-tips-btn-name">å‰¯æ¥­ã‚ªã‚¿ã‚¯ã«ã‚ƒãµã€œã•ã‚“</div>
          <div class="income-tips-btn-sub">è‘—è€…ãƒ»å‰¯æ¥­ãƒã‚¦ãƒã‚¦</div>
        </a>
        <a class="income-tips-btn"
           href="https://tqv.jp/u/kumasanpou/a/oeHdWEnj/BaID7R6d"
           target="_blank" rel="noopener noreferrer"
           onclick="trackIncomeCta('tips_kumasanpo')">
          <div class="income-tips-btn-icon">ğŸ»</div>
          <div class="income-tips-btn-name">ãã¾ã•ã‚“ã½ã•ã‚“</div>
          <div class="income-tips-btn-sub">è‘—è€…ãƒ»åå…¥ã‚¢ãƒƒãƒ—è¡“</div>
        </a>
      </div>
    </div>
  </div>
  <!-- ===== /åå…¥ã‚¢ãƒƒãƒ—ã‚µãƒãƒ¼ãƒˆ ===== -->

  <!-- OCR Upload -->
  <div class="ocr-section">
    <!-- Platform-specific hint -->
    <div class="ocr-platform-hint" id="ocr-hint"></div>

    <div class="auto-save-row">
      <span>è‡ªå‹•ä¿å­˜</span>
      <div class="toggle" id="auto-save-toggle" onclick="toggleAutoSave()">
        <div class="toggle-thumb"></div>
      </div>
    </div>

    <div class="upload-zone" id="upload-zone">
      <input type="file" accept="image/*" multiple id="file-input" onchange="handleFiles(this.files)"/>
      <div class="upload-icon">â¬†ï¸</div>
      <div class="upload-title">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
      <div class="upload-sub">ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ ã¾ãŸã¯ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
    </div>

    <div class="ocr-preview" id="ocr-preview">
      <div class="ocr-preview-title" id="ocr-preview-title">ğŸ“Š è§£æçµæœï¼ˆç·¨é›†å¯èƒ½ï¼‰</div>
      <div class="ocr-field">
        <span class="ocr-field-label">å£²ä¸Šé‡‘é¡<span class="conf-badge" id="conf-sales"></span></span>
        <input class="ocr-field-input" id="ocr-sales" type="number" placeholder="0" oninput="recalcOcr()"/>
      </div>
      <div class="candidate-row" id="cand-sales"></div>
      <div class="ocr-field">
        <span class="ocr-field-label">é…é”ä»¶æ•°<span class="conf-badge" id="conf-count"></span></span>
        <input class="ocr-field-input" id="ocr-count" type="number" placeholder="0" oninput="recalcOcr()"/>
      </div>
      <div class="candidate-row" id="cand-count"></div>
      <div class="ocr-field">
        <span class="ocr-field-label">ç·è·é›¢ (km)<span class="conf-badge" id="conf-dist"></span></span>
        <input class="ocr-field-input" id="ocr-dist" type="number" placeholder="0" oninput="recalcOcr()"/>
      </div>
      <div class="candidate-row" id="cand-dist"></div>
      <div class="ocr-field">
        <span class="ocr-field-label">ç¨¼åƒæ™‚é–“ (h)<span class="conf-badge" id="conf-hours"></span></span>
        <input class="ocr-field-input" id="ocr-hours" type="number" placeholder="0" oninput="recalcOcr()"/>
      </div>
      <div class="candidate-row" id="cand-hours"></div>
    </div>

    <button class="analyze-btn" id="analyze-btn" onclick="saveOcrDataOrOpenManual()">
      <span>âŠ¡</span> ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    </button>
    <div style="text-align:center;font-size:10px;color:var(--text3);padding-bottom:10px;">
      é…é”å˜ä¾¡ãƒã‚§ãƒƒã‚«ãƒ¼ v5.3 â€” OCR powered by Tesseract.js
    </div>
  </div>
</div>

<!-- ===== HISTORY ===== -->
<div id="page-history" class="page">
  <div class="page-header">ğŸ“‹ å±¥æ­´</div>
  <!-- Filter chips -->
  <div class="filter-bar">
    <button class="filter-chip active" id="hf-all"    onclick="setHistoryFilter('all')">ã™ã¹ã¦</button>
    <button class="filter-chip chip-uber"   id="hf-uber"   onclick="setHistoryFilter('uber')">ğŸŸ¢ Uber Eats</button>
    <button class="filter-chip chip-rocket" id="hf-rocket" onclick="setHistoryFilter('rocketnow')">ğŸŸ  RocketNow</button>
  </div>
  <div id="history-list"></div>
</div>

<!-- ===== REPORT ===== -->
<div id="page-report" class="page">
  <div class="report-header">
    <div class="report-title">ãƒ‡ãƒªãƒãƒªãƒ¼æˆç¸¾è©•ä¾¡</div>
  </div>

  <!-- Filter chips -->
  <div class="filter-bar">
    <button class="filter-chip active" id="rf-all"    onclick="setReportFilter('all')">ã™ã¹ã¦</button>
    <button class="filter-chip chip-uber"   id="rf-uber"   onclick="setReportFilter('uber')">ğŸŸ¢ Uber Eats</button>
    <button class="filter-chip chip-rocket" id="rf-rocket" onclick="setReportFilter('rocketnow')">ğŸŸ  RocketNow</button>
  </div>

  <div class="perf-grid">
    <div class="perf-item">
      <div class="perf-label">ğŸ“¦ ä»¶æ•°</div>
      <div class="perf-value"><span id="r-count">â€”</span><span class="perf-unit">ä»¶</span></div>
    </div>
    <div class="perf-item">
      <div class="perf-label">ğŸ è·é›¢åŠ¹ç‡</div>
      <div class="perf-value"><span id="r-kmprice">â€”</span><span class="perf-unit">å††/km</span></div>
    </div>
    <div class="perf-item">
      <div class="perf-label">â± æ™‚é–“åŠ¹ç‡</div>
      <div class="perf-value"><span id="r-hourly">â€”</span><span class="perf-unit">å††/h</span></div>
    </div>
    <div class="perf-item">
      <div class="perf-label">âš¡ è·é›¢é”æˆåº¦</div>
      <div class="perf-value"><span id="r-speed">â€”</span><span class="perf-unit">km/h</span></div>
    </div>
  </div>

  <!-- Platform breakdown -->
  <div class="platform-breakdown" id="platform-breakdown"></div>

  <div class="advice-card">
    <div class="advice-header">
      <div class="advice-title">ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div>
      <div class="ai-badge" onclick="getAIAdvice()">âœ¦ AIã‚¢ãƒ‰ãƒã‚¤ã‚¹</div>
    </div>
    <div id="advice-list">
      <div class="empty-state" style="padding:16px 0">
        <div class="empty-icon" style="font-size:28px">ğŸ¤–</div>
        <div class="empty-text" style="font-size:12px">ã€ŒAIã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„</div>
      </div>
    </div>
    <div class="ai-thinking" id="ai-thinking">âœ¦ AIåˆ†æä¸­...</div>
  </div>

  <div class="compare-section">
    <div class="compare-title">æœ€é«˜å€¤ã¨ã®æ¯”è¼ƒ</div>
    <div class="compare-grid">
      <div class="compare-card">
        <div class="compare-header"><div class="compare-badge">ğŸ‘¤</div>ãƒ¦ãƒ¼ã‚¶ãƒ¼<span style="font-size:9px;color:var(--text3)">ä»Šæ—¥</span></div>
        <div class="compare-row"><div class="compare-label">ä»¶æ•°</div><div class="compare-val"><span id="cmp-count">â€”</span>ä»¶ <span class="trend-up">â†‘</span></div></div>
        <div class="compare-row"><div class="compare-label">1ä»¶å˜ä¾¡</div><div class="compare-val"><span id="cmp-unit">â€”</span>å†† <span class="trend-up">â†‘</span></div></div>
        <div class="compare-row"><div class="compare-label">è·é›¢åŠ¹ç‡</div><div class="compare-val"><span id="cmp-km">â€”</span>å††/km <span class="trend-up">â†‘</span></div></div>
      </div>
      <div class="compare-card best">
        <div class="compare-header"><div class="compare-badge">ğŸ†</div>è‡ªå·±æœ€é«˜<span style="font-size:9px;color:var(--text3)">ãƒ™ã‚¹ãƒˆ</span></div>
        <div class="compare-row"><div class="compare-label">ä»¶æ•°</div><div class="compare-val" style="color:var(--yellow)"><span id="best-count">â€”</span>ä»¶ <span class="trend-up">â†‘</span></div></div>
        <div class="compare-row"><div class="compare-label">1ä»¶å˜ä¾¡</div><div class="compare-val" style="color:var(--yellow)"><span id="best-unit">â€”</span>å†† <span class="trend-up">â†‘</span></div></div>
        <div class="compare-row"><div class="compare-label">è·é›¢åŠ¹ç‡</div><div class="compare-val" style="color:var(--yellow)"><span id="best-km">â€”</span>å††/km <span class="trend-up">â†‘</span></div></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== RANKINGS ===== -->
<div id="page-rankings" class="page">
  <div class="page-header">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
 
  <!-- Rank type tabs -->
  <div class="rank-tabs">
    <button class="rank-tab active" id="rt-earnings"    onclick="setRankType('earnings')">ç´¯è¨ˆå£²ä¸Š</button>
    <button class="rank-tab"        id="rt-deliveries"  onclick="setRankType('deliveries')">ç´¯è¨ˆä»¶æ•°</button>
    <button class="rank-tab"        id="rt-hourly"      onclick="setRankType('hourly')">å¹³å‡æ™‚çµ¦</button>
    <button class="rank-tab"        id="rt-efficiency"  onclick="setRankType('efficiency')">è·é›¢åŠ¹ç‡</button>
  </div>

  <!-- Ranking list -->
  <div style="padding:12px 16px;" id="rank-list">
    <div class="empty-state">
      <div class="empty-icon">ğŸ”</div>
      <div class="empty-text">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</div>
      <div class="empty-sub">è¨­å®šãƒšãƒ¼ã‚¸ã‹ã‚‰Googleãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</div>
    </div>
  </div>
</div>

<!-- ===== SETTINGS ===== -->
<div id="page-settings" class="page">
  <div class="settings-header">
    <div class="back-btn" onclick="switchTab('home')">â†</div>
    <div class="settings-title">è¨­å®š</div>
  </div>
  <div class="settings-section">
    <div class="settings-section-title">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
   
    <!-- Logged Out State -->
    <div class="auth-logged-out" id="auth-logged-out">
      <div style="font-size:13px;color:var(--text2);margin-bottom:12px;line-height:1.6;">
        ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã•ã‚Œã€è‡ªå·±æœ€é«˜è¨˜éŒ²ãƒ»ç´¯è¨ˆçµ±è¨ˆãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã™ã€‚
      </div>
      <button class="login-btn" onclick="loginWithGoogle()">
        <span style="font-size:18px">ğŸ”</span>
        Googleã§ãƒ­ã‚°ã‚¤ãƒ³
      </button>
    </div>

    <!-- Logged In State -->
    <div class="auth-logged-in" id="auth-logged-in">
      <div class="account-row">
        <div class="account-avatar" id="user-avatar">ğŸ‘¤</div>
        <div>
          <div class="account-name" id="user-name">èª­ã¿è¾¼ã¿ä¸­...</div>
          <div class="account-email" id="user-email">â€”</div>
        </div>
      </div>
     
      <!-- ç´¯è¨ˆçµ±è¨ˆ -->
      <div class="user-stats-grid" id="user-stats-grid">
        <div class="user-stat-card">
          <div class="user-stat-label">ç´¯è¨ˆå£²ä¸Š</div>
          <div class="user-stat-value" id="total-earnings">Â¥â€”</div>
        </div>
        <div class="user-stat-card">
          <div class="user-stat-label">ç´¯è¨ˆä»¶æ•°</div>
          <div class="user-stat-value" id="total-deliveries">â€”ä»¶</div>
        </div>
        <div class="user-stat-card">
          <div class="user-stat-label">ç´¯è¨ˆè·é›¢</div>
          <div class="user-stat-value" id="total-distance">â€”km</div>
        </div>
        <div class="user-stat-card">
          <div class="user-stat-label">å¹³å‡æ™‚çµ¦</div>
          <div class="user-stat-value" id="avg-hourly">Â¥â€”</div>
        </div>
      </div>

      <button class="logout-btn" onclick="logout()" style="margin-top:12px;">
        â†’ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      </button>
    </div>
  </div>
  <div class="settings-section">
    <div class="settings-section-title">ğŸ“± iPhoneã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆé€£æº</div>
    <div style="font-size:13px;color:var(--text2);line-height:1.8;">
      iPhoneã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚’ä½¿ã†ã¨ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±å¾Œã™ãã«è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚<br><br>
      <strong style="color:var(--text)">1. ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚’é–‹ã</strong><br>
      <span style="color:var(--text3)">iPhoneæ¨™æº–ã®ã€Œã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã€ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã€ã€Œ+ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ–°è¦ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚</span>
    </div>
  </div>
  <div class="settings-section">
    <div class="settings-section-title">åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½</div>
    <div class="feature-item"><div class="feature-dot"></div>ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆOCRè§£æ</div>
    <div class="feature-item"><div class="feature-dot"></div>ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆ¥ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
    <div class="feature-item"><div class="feature-dot"></div>é…é”ãƒ­ã‚°ã®ä¿å­˜ãƒ»ç®¡ç†</div>
    <div class="feature-item"><div class="feature-dot"></div>æ—¥æ¬¡é›†è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
    <div class="feature-item"><div class="feature-dot"></div>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°</div>
    <div class="feature-item"><div class="feature-dot"></div>AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ</div>
    <div class="feature-item"><div class="feature-dot"></div>ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ¯”è¼ƒ</div>
    <div style="font-size:10px;color:var(--text3);margin-top:6px;">ã™ã¹ã¦ã®æ©Ÿèƒ½ã‚’ç„¡æ–™ã§ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™</div>
  </div>
  <div class="settings-section">
    <div class="settings-section-title">ã‚¢ãƒ—ãƒªæƒ…å ±</div>
    <div class="info-row"><span class="info-label">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</span><span class="info-value">v5.3</span></div>
    <div class="info-row"><span class="info-label">OCRã‚¨ãƒ³ã‚¸ãƒ³</span><span class="info-value">Tesseract.js</span></div>
    <div class="info-row"><span class="info-label">AI</span><span class="info-value">Claude LLM</span></div>
  </div>
  <div class="disclaimer">
    <span>â„¹ï¸</span>
    <span>OCRè§£æã®ç²¾åº¦ã¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®ç”»è³ªã‚„è¡¨ç¤ºå†…å®¹ã«ä¾å­˜ã—ã¾ã™ã€‚æŠ½å‡ºçµæœãŒæ­£ç¢ºã§ãªã„å ´åˆã¯ã€æ‰‹å‹•ä¿®æ­£æ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚</span>
  </div>
</div>

<!-- Manual Input Modal -->
<div class="modal-overlay" id="manual-modal">
  <div class="modal">
    <div class="modal-title">ğŸ“ æ‰‹å‹•ã§ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›</div>
    <div class="modal-form-group">
      <label class="modal-label">æ—¥ä»˜</label>
      <input type="date" id="m-date" class="modal-input"/>
    </div>
    <div class="modal-form-group">
      <label class="modal-label">ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </label>
      <select id="m-platform" class="modal-input">
        <option value="uber">ğŸŸ¢ Uber Eats</option>
        <option value="rocketnow">ğŸŸ  RocketNow</option>
      </select>
    </div>
    <div class="modal-form-group">
      <label class="modal-label">å£²ä¸Šé‡‘é¡ï¼ˆå††ï¼‰</label>
      <input type="number" id="m-sales" class="modal-input" placeholder="ä¾‹ï¼š4976" inputmode="numeric"/>
    </div>
    <div class="modal-form-group">
      <label class="modal-label">é…é”ä»¶æ•°</label>
      <input type="number" id="m-count" class="modal-input" placeholder="ä¾‹ï¼š4" inputmode="numeric"/>
    </div>
    <div class="modal-form-group">
      <label class="modal-label">ç·è·é›¢ï¼ˆkmï¼‰</label>
      <input type="number" id="m-dist" class="modal-input" placeholder="ä¾‹ï¼š28.6" inputmode="decimal" step="0.1"/>
    </div>
    <div class="modal-form-group">
      <label class="modal-label">ç¨¼åƒæ™‚é–“ï¼ˆæ™‚é–“ï¼‰</label>
      <input type="number" id="m-hours" class="modal-input" placeholder="ä¾‹ï¼š1.54" inputmode="decimal" step="0.01"/>
    </div>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-cancel" onclick="closeManualModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="modal-btn modal-btn-primary" onclick="saveManual()">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- Bottom Nav -->
<div class="bottom-nav">
  <button class="nav-btn active" id="nav-home"     onclick="switchTab('home')">    <span class="nav-icon">ğŸ </span>ãƒ›ãƒ¼ãƒ </button>
  <button class="nav-btn"        id="nav-history"  onclick="switchTab('history')"> <span class="nav-icon">ğŸ•</span>å±¥æ­´</button>
  <button class="nav-btn"        id="nav-report"   onclick="switchTab('report')">  <span class="nav-icon">ğŸ“‹</span>æ—¥å ±</button>
  <button class="nav-btn"        id="nav-rankings" onclick="switchTab('rankings')"><span class="nav-icon">ğŸ†</span>ãƒ©ãƒ³ã‚¯</button>
  <button class="nav-btn"        id="nav-settings" onclick="switchTab('settings')"><span class="nav-icon">âš™ï¸</span>è¨­å®š</button>
</div>

<div class="loading-overlay" id="loading"><div class="spinner"></div><div class="loading-text" id="loading-text">è§£æä¸­...</div><div class="loading-steps"><div class="step-dot" id="step-0"></div><div class="step-dot" id="step-1"></div><div class="step-dot" id="step-2"></div></div><div class="loading-progress-bar"><div class="loading-progress-fill" id="loading-progress"></div></div></div>
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE & STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentPlatform = localStorage.getItem('dc_platform') || 'uber';
let autoSave        = false;
let pendingOcrData  = null;
let historyFilter   = 'all';
let reportFilter    = 'all';

function getLogs(){ return JSON.parse(localStorage.getItem('dc_logs')||'[]'); }
function saveLogs(l){ localStorage.setItem('dc_logs', JSON.stringify(l)); }
function getTodayKey(){ return new Date().toISOString().slice(0,10); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init(){
  try {
    const dateInput = document.getElementById('m-date');
    if(dateInput) dateInput.value = getTodayKey();
   
    applyPlatformUI(currentPlatform);
    updateHomeStats();
    renderHistory();
    renderReport();
    setupDragDrop();
   
    console.log('[App] âœ… Initialized successfully');
  } catch(err){
    console.error('[App Init Error]', err);
  }
}

if(document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLATFORM SELECTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectPlatform(p){
  currentPlatform = p;
  localStorage.setItem('dc_platform', p);
  applyPlatformUI(p);
  updateHomeStats();
}

function applyPlatformUI(p){
  const isUber   = p === 'uber';
  const isRocket = p === 'rocketnow';

  const ub = document.getElementById('pb-uber');
  const rb = document.getElementById('pb-rocket');
  ub.className = 'platform-btn' + (isUber   ? ' active-uber'   : '');
  rb.className = 'platform-btn' + (isRocket ? ' active-rocket' : '');

  const card = document.getElementById('home-sales-card');
  card.classList.toggle('platform-uber',   isUber);
  card.classList.toggle('platform-rocket', isRocket);

  const hint = document.getElementById('ocr-hint');
  if(isUber){
    hint.className = 'ocr-platform-hint hint-uber';
    hint.innerHTML = 'ğŸŸ¢ <strong>Uber Eats</strong> ãƒ¢ãƒ¼ãƒ‰ â€” å£²ä¸Šãƒ»ä»¶æ•°ãƒ»è·é›¢ãƒ»æ™‚é–“ã‚’è‡ªå‹•æŠ½å‡º';
  } else {
    hint.className = 'ocr-platform-hint hint-rocket';
    hint.innerHTML = 'ğŸŸ  <strong>RocketNow</strong> ãƒ¢ãƒ¼ãƒ‰ â€” é…é”å ±é…¬ãƒ»èµ°è¡Œè·é›¢ã‚’è‡ªå‹•æŠ½å‡º';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OCR PARSING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseUberScreenshot(t){
  const data = { sales:0, count:0, dist:0, hours:0 };
  const salesM = t.match(/[Â¥ï¿¥]\s*([\d,ï¼Œ]+)/);
  if(salesM) data.sales = parseInt(salesM[1].replace(/[,ï¼Œ]/g,''));
  const countM = t.match(/é…é”[^\d]*(\d+)/) || t.match(/(\d+)\s*ä»¶/);
  if(countM) data.count = parseInt(countM[1]);
  const distM = t.match(/([\d.]+)\s*km/i);
  if(distM) data.dist = parseFloat(distM[1]);
  const minM = t.match(/(\d+)\s*åˆ†/);
  const hourM = t.match(/([\d.]+)\s*h/i);
  const colonM = t.match(/(\d+):(\d+)/);
  if(minM)        data.hours = parseFloat((parseInt(minM[1])/60).toFixed(2));
  else if(hourM)  data.hours = parseFloat(hourM[1]);
  else if(colonM) data.hours = parseFloat((parseInt(colonM[1]) + parseInt(colonM[2])/60).toFixed(2));
  return data;
}

function parseRocketNowScreenshot(t){
  const data = { sales:0, count:0, dist:0, hours:0 };
  const salesM = t.match(/([\d,ï¼Œ]+)\s*å††/) || t.match(/[Â¥ï¿¥]\s*([\d,ï¼Œ]+)/);
  if(salesM) data.sales = parseInt(salesM[1].replace(/[,ï¼Œ]/g,''));
  const distM = t.match(/é…é”è·é›¢\s*([\d.]+)\s*km/i) || t.match(/([\d.]+)\s*km/i);
  if(distM) data.dist = parseFloat(distM[1]);
  const countM = t.match(/ãƒŸãƒƒã‚·ãƒ§ãƒ³\s*(\d+)\s*ä»¶/)
               || t.match(/é…é”\s*(\d+)\s*å›/)
               || t.match(/(\d+)\s*ä»¶/);
  if(countM) data.count = parseInt(countM[1]);
  const hourM = t.match(/([\d.]+)\s*h/i) || t.match(/(\d+)\s*åˆ†/);
  if(hourM && hourM[0].includes('åˆ†')) data.hours = parseFloat((parseInt(hourM[1])/60).toFixed(2));
  else if(hourM) data.hours = parseFloat(hourM[1]);
  return data;
}

function parseScreenshot(text, platform){
  return platform === 'uber' ? parseUberScreenshot(text) : parseRocketNowScreenshot(text);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMAGE PREPROCESSING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function preprocessImageCanvas(file){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = ()=>{
      try {
        const sw = Math.floor(img.width * 0.8);
        const sh = Math.floor(img.height * 0.55);
        const canvas = document.createElement('canvas');
        canvas.width = sw; canvas.height = sh;
        const ctx = canvas.getContext('2d');
        const sx = Math.floor((img.width - sw) / 2);
        ctx.drawImage(img, sx, 0, sw, sh, 0, 0, sw, sh);
        const imgData = ctx.getImageData(0, 0, sw, sh);
        const d = imgData.data;
        for(let i=0; i<d.length; i+=4){
          const gray = Math.round(0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2]);
          const c = Math.min(255, Math.max(0, (gray - 128) * 2 + 128));
          const bin = c >= 128 ? 255 : 0;
          d[i] = d[i+1] = d[i+2] = bin;
        }
        ctx.putImageData(imgData, 0, 0);
        URL.revokeObjectURL(url);
        canvas.toBlob(blob => blob ? resolve(blob) : reject(new Error('toBlob failed')), 'image/png');
      } catch(e){ URL.revokeObjectURL(url); reject(e); }
    };
    img.onerror = ()=>{ URL.revokeObjectURL(url); reject(new Error('Image load failed')); };
    img.src = url;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  3-STEP ANIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STEP_MSGS = ['ğŸ“ æœ€é©åŒ–ä¸­...', 'ğŸ” èªè­˜ä¸­...', 'ğŸ“Š æŠ½å‡ºä¸­...'];
function setOcrStep(step){
  document.getElementById('loading-text').textContent = STEP_MSGS[step] || '';
  for(let i=0; i<3; i++){
    const dot = document.getElementById('step-'+i);
    if(!dot) continue;
    dot.className = i < step ? 'step-dot done' : i === step ? 'step-dot active' : 'step-dot';
  }
  const fill = document.getElementById('loading-progress');
  if(fill) fill.style.width = Math.round((step+1)/3*100)+'%';
}
function resetOcrSteps(){
  for(let i=0; i<3; i++){
    const dot = document.getElementById('step-'+i);
    if(dot) dot.className='step-dot';
  }
  const fill = document.getElementById('loading-progress');
  if(fill) fill.style.width='0';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UNIFIED OCR REGEX EXTRACTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PATTERNS = {
  sales: /Â¥\s?([\d,]+)/g,
  count: /(\d+)\s?(ä»¶|é…é”)/g,
  hours: /(\d+)\s?åˆ†/g,
  dist:  /([\d.]+)\s?km/g
};
function extractAllMatches(text, patternSource){
  const re = new RegExp(patternSource, 'g');
  const matches = [];
  let m;
  while((m = re.exec(text)) !== null){
    const val = parseFloat(m[1].replace(/,/g,''));
    if(!isNaN(val)) matches.push(val);
  }
  return matches;
}
function extractDeliveryData(text){
  const salesM  = extractAllMatches(text, PATTERNS.sales.source);
  const countM  = extractAllMatches(text, PATTERNS.count.source).filter(v=>v>0&&v<500);
  const minuteM = extractAllMatches(text, PATTERNS.hours.source);
  const distM   = extractAllMatches(text, PATTERNS.dist.source).filter(v=>v>0&&v<2000);
  const sales = salesM.length > 0 ? Math.max(...salesM) : 0;
  const count = countM[0] || 0;
  const hours = minuteM.length > 0 ? parseFloat((minuteM[0]/60).toFixed(2)) : 0;
  const dist  = distM[0] || 0;
  return {
    sales, count, hours, dist,
    candidates:{
      sales: salesM,
      count: countM,
      hours: minuteM.map(v=>parseFloat((v/60).toFixed(2))),
      dist:  distM
    }
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIDENCE PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getConfLevel(val, candidates){
  if(val > 0 && candidates.length === 1) return 'high';
  if(val > 0 && candidates.length > 1)  return 'mid';
  return 'low';
}
const CONF_LABELS = {high:'é«˜', mid:'ä¸­', low:'ä½'};
function showConfidencePanel(extracted){
  const fields = [
    {id:'sales', val:extracted.sales, cands:extracted.candidates.sales},
    {id:'count', val:extracted.count, cands:extracted.candidates.count},
    {id:'dist',  val:extracted.dist,  cands:extracted.candidates.dist},
    {id:'hours', val:extracted.hours, cands:extracted.candidates.hours}
  ];
  fields.forEach(f=>{
    const badge   = document.getElementById('conf-'+f.id);
    const candRow = document.getElementById('cand-'+f.id);
    if(!badge || !candRow) return;
    const level = getConfLevel(f.val, f.cands);
    badge.className = 'conf-badge '+level;
    badge.textContent = CONF_LABELS[level];
    candRow.innerHTML = '';
    if(f.cands.length > 1){
      f.cands.forEach(c=>{
        const btn = document.createElement('button');
        btn.className = 'candidate-btn'+(c===f.val?' selected':'');
        btn.textContent = c;
        btn.onclick = ()=>setCandidateValue(f.id, c, candRow, btn);
        candRow.appendChild(btn);
      });
    }
  });
}
function setCandidateValue(fieldId, val, row, btn){
  document.getElementById('ocr-'+fieldId).value = val;
  row.querySelectorAll('.candidate-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  recalcOcr();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupDragDrop(){
  const zone = document.getElementById('upload-zone');
  zone.addEventListener('dragover', e=>{ e.preventDefault(); zone.classList.add('drag'); });
  zone.addEventListener('dragleave', ()=> zone.classList.remove('drag'));
  zone.addEventListener('drop', e=>{ e.preventDefault(); zone.classList.remove('drag'); handleFiles(e.dataTransfer.files); });
}

function loadTesseract(){
  return new Promise(resolve=>{
    if(window.Tesseract){ resolve(true); return; }
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
    s.onload  = ()=>resolve(true);
    s.onerror = ()=>resolve(false);
    document.head.appendChild(s);
  });
}

async function handleFiles(files){
  if(!files||!files.length) return;
  const file = files[0];
  resetOcrSteps();
  setOcrStep(0);
  document.getElementById('loading').classList.add('show');

  try {
    // Step 0: Canvas preprocessing
    let processedFile;
    try {
      processedFile = await preprocessImageCanvas(file);
    } catch(e){
      console.warn('[Preprocess] fallback to original', e);
      processedFile = file;
    }

    // Step 1: Load Tesseract + OCR
    setOcrStep(1);
    const ok = await loadTesseract();
    if(!ok || !window.Tesseract) throw new Error('Tesseract load failed');

    const result = await Tesseract.recognize(processedFile, 'jpn+eng', {
      logger: m=>{
        if(m.status === 'recognizing text'){
          document.getElementById('loading-text').textContent =
            `ğŸ” èªè­˜ä¸­... ${Math.round(m.progress*100)}%`;
        }
      }
    });

    // Step 2: Extract data
    setOcrStep(2);
    await new Promise(r=>setTimeout(r, 300));

    const rawText = result.data.text;
    console.log('[OCR RAW TEXT]', rawText);

    const extracted = extractDeliveryData(rawText);
    const parsed = { sales:extracted.sales, count:extracted.count, dist:extracted.dist, hours:extracted.hours };

    hideLoading();
    resetOcrSteps();

    if(parsed.sales === 0 && parsed.count === 0 && parsed.dist === 0){
      showToast('âš ï¸ æ•°å€¤ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§ä¿®æ­£ã—ã¦ãã ã•ã„','#ffc107');
    } else {
      showToast('ğŸ“¸ OCRè§£æå®Œäº†ï¼æ•°å€¤ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„');
    }
    showOcrPreview(parsed);
    showConfidencePanel(extracted);

  } catch(err){
    console.error('[OCR Error]', err);
    hideLoading();
    resetOcrSteps();
    showToast('âš ï¸ OCRå¤±æ•—ã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„','#ffc107');
    openManualModal();
  }
}

function showOcrPreview(data){
  pendingOcrData = data;
  document.getElementById('ocr-sales').value  = data.sales;
  document.getElementById('ocr-count').value  = data.count;
  document.getElementById('ocr-dist').value   = data.dist;
  document.getElementById('ocr-hours').value  = data.hours;
  const isRocket = currentPlatform === 'rocketnow';
  document.getElementById('ocr-preview-title').textContent =
    (isRocket ? 'ğŸŸ  RocketNow' : 'ğŸŸ¢ Uber Eats') + ' è§£æçµæœï¼ˆç·¨é›†å¯èƒ½ï¼‰';
  document.getElementById('ocr-preview').classList.add('show');
  recalcOcr();
}

function recalcOcr(){
  const sales  = parseFloat(document.getElementById('ocr-sales').value)||0;
  const count  = parseFloat(document.getElementById('ocr-count').value)||0;
  const dist   = parseFloat(document.getElementById('ocr-dist').value)||0;
  const hours  = parseFloat(document.getElementById('ocr-hours').value)||0;
  pendingOcrData = {sales,count,dist,hours};
  updateHomeLive(sales,count,dist,hours);
}

function saveOcrDataOrOpenManual(){
  if(pendingOcrData){
    saveOcrData();
  } else {
    openManualModal();
  }
}

function saveOcrData(){
  const {sales,count,dist,hours} = pendingOcrData;
  if(!sales && !count){ showToast('âš ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','#ff5252'); return; }
  const log = buildLog(getTodayKey(), sales, count, dist, hours, currentPlatform);
 
  const logs = getLogs(); logs.push(log); saveLogs(logs);
  pendingOcrData = null;
  document.getElementById('ocr-preview').classList.remove('show');
  document.getElementById('file-input').value = '';
  const todayCount = getLogs().filter(l=>l.date===getTodayKey()).length;
  document.getElementById('analysis-count').textContent = todayCount + 'ä»¶ã®è§£æ';
  updateHomeStats();
  renderHistory();
  showToast(`âœ… ${platformName(currentPlatform)}ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOG BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildLog(date, sales, count, dist, hours, platform){
  return {
    id: Date.now().toString(),
    date, sales, count,
    dist:   parseFloat(dist)||0,
    hours:  parseFloat(hours)||0,
    platform: platform || 'uber',
    timestamp: Date.now(),
    hourly:  hours>0 ? Math.round(sales/hours) : 0,
    unit:    count>0 ? Math.round(sales/count) : 0,
    kmprice: dist>0  ? Math.round(sales/dist)  : 0,
    speed:   hours>0 ? Math.round(dist/hours*10)/10 : 0
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOME STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHomeStats(){
  const today = getTodayKey();
  const logs  = getLogs().filter(l => l.date === today);
  const sales = logs.reduce((s,l)=>s+l.sales,0);
  const count = logs.reduce((s,l)=>s+l.count,0);
  const dist  = logs.reduce((s,l)=>s+l.dist, 0);
  const hours = logs.reduce((s,l)=>s+l.hours,0);
  updateHomeLive(sales,count,dist,hours);
  document.getElementById('analysis-count').textContent =
    logs.length>0 ? logs.length+'ä»¶ã®è§£æ' : 'â€” ä»¶ã®è§£æ';
}

function updateHomeLive(sales,count,dist,hours){
  document.getElementById('home-sales').textContent = 'Â¥'+sales.toLocaleString('ja-JP');
  document.getElementById('h-count').textContent    = count + 'ä»¶';
  document.getElementById('h-dist').textContent     = dist.toFixed(1)+'km';
  document.getElementById('h-hours').textContent    = hours.toFixed(2)+'h';
  document.getElementById('h-hourly').textContent   = hours>0 ? 'Â¥'+Math.round(sales/hours).toLocaleString('ja-JP') : 'Â¥â€”';
  document.getElementById('h-kmprice').textContent  = dist>0  ? 'Â¥'+Math.round(sales/dist).toLocaleString('ja-JP')  : 'Â¥â€”';
  document.getElementById('h-unit').textContent     = count>0 ? 'Â¥'+Math.round(sales/count).toLocaleString('ja-JP') : 'Â¥â€”';
  document.getElementById('h-speed').textContent    = hours>0 ? (dist/hours).toFixed(1) : 'â€”';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _historyFilter = 'all';
function setHistoryFilter(f){
  _historyFilter = f;
  document.getElementById('hf-all').classList.toggle('active', f==='all');
  document.getElementById('hf-uber').classList.toggle('active', f==='uber');
  document.getElementById('hf-rocket').classList.toggle('active', f==='rocketnow');
  renderHistory();
}

function renderHistory(){
  let logs = [...getLogs()].sort((a,b)=>b.date.localeCompare(a.date)||b.id.localeCompare(a.id));
  if(_historyFilter !== 'all') logs = logs.filter(l=>(l.platform||'uber')===_historyFilter);
  const el = document.getElementById('history-list');
  if(!logs.length){
    el.innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-text">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div><div class="empty-sub">${_historyFilter!=='all'?platformName(_historyFilter)+'ã®':''}ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</div></div>`;
    return;
  }
  el.innerHTML = logs.map(l=>`
    <div class="history-item">
      <div class="history-left">
        <div class="history-date">
          ${fmtDate(l.date)}
          <span class="badge ${platformBadgeClass(l.platform)}">${platformName(l.platform)}</span>
        </div>
        <div class="history-meta">${l.count}ä»¶ / ${l.dist}km / ${l.hours}h</div>
      </div>
      <div class="history-right">
        <div class="history-sales">Â¥${l.sales.toLocaleString('ja-JP')}</div>
        <div class="history-hourly">æ™‚çµ¦Â¥${l.hourly.toLocaleString('ja-JP')}</div>
      </div>
      <button class="history-delete" onclick="deleteLog('${l.id}')">å‰Šé™¤</button>
    </div>
  `).join('');
}

function deleteLog(id){
  if(!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  saveLogs(getLogs().filter(l=>l.id!==id));
  renderHistory(); renderReport(); updateHomeStats();
  showToast('ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ','#ff5252');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _reportFilter = 'all';
function setReportFilter(f){
  _reportFilter = f;
  document.getElementById('rf-all').classList.toggle('active', f==='all');
  document.getElementById('rf-uber').classList.toggle('active', f==='uber');
  document.getElementById('rf-rocket').classList.toggle('active', f==='rocketnow');
  renderReport();
}

function renderReport(){
  const today = getTodayKey();
  let logs = getLogs().filter(l=>l.date===today);
  if(_reportFilter !== 'all') logs = logs.filter(l=>(l.platform||'uber')===_reportFilter);

  if(!logs.length){
    ['r-count','r-kmprice','r-hourly','r-speed'].forEach(id=>document.getElementById(id).textContent='â€”');
    ['cmp-count','cmp-unit','cmp-km','best-count','best-unit','best-km'].forEach(id=>document.getElementById(id).textContent='â€”');
    document.getElementById('platform-breakdown').innerHTML='';
    return;
  }

  const sales  = logs.reduce((s,l)=>s+l.sales,0);
  const count  = logs.reduce((s,l)=>s+l.count,0);
  const dist   = logs.reduce((s,l)=>s+l.dist, 0);
  const hours  = logs.reduce((s,l)=>s+l.hours,0);
  const hourly = hours>0 ? Math.round(sales/hours) : 0;
  const kmprice= dist>0  ? Math.round(sales/dist)  : 0;
  const speed  = hours>0 ? Math.round(dist/hours*10)/10 : 0;
  const unit   = count>0 ? Math.round(sales/count) : 0;

  document.getElementById('r-count').textContent   = count;
  document.getElementById('r-kmprice').textContent = kmprice.toLocaleString('ja-JP');
  document.getElementById('r-hourly').textContent  = hourly.toLocaleString('ja-JP');
  document.getElementById('r-speed').textContent   = speed;

  document.getElementById('cmp-count').textContent = count;
  document.getElementById('cmp-unit').textContent  = unit.toLocaleString('ja-JP');
  document.getElementById('cmp-km').textContent    = kmprice.toLocaleString('ja-JP');

  const allLogs  = getLogs();
  const bestCount  = Math.max(...allLogs.map(l=>l.count),  0);
  const bestUnit   = Math.max(...allLogs.map(l=>l.unit),   0);
  const bestKm     = Math.max(...allLogs.map(l=>l.kmprice),0);
  document.getElementById('best-count').textContent = bestCount || 'â€”';
  document.getElementById('best-unit').textContent  = bestUnit ? bestUnit.toLocaleString('ja-JP') : 'â€”';
  document.getElementById('best-km').textContent    = bestKm ? bestKm.toLocaleString('ja-JP') : 'â€”';

  renderPlatformBreakdown(today);
}

function renderPlatformBreakdown(today){
  const allToday = getLogs().filter(l=>l.date===today);
  const platforms = ['uber','rocketnow'];
  const el = document.getElementById('platform-breakdown');
  const cards = platforms.map(p=>{
    const pl = allToday.filter(l=>(l.platform||'uber')===p);
    if(!pl.length) return '';
    const s = pl.reduce((a,l)=>a+l.sales,0);
    const c = pl.reduce((a,l)=>a+l.count,0);
    const h = pl.reduce((a,l)=>a+l.hours,0);
    const hr= h>0?Math.round(s/h):0;
    return `<div class="pb-card">
      <div class="pb-header">
        <div class="pb-title"><span class="badge ${platformBadgeClass(p)}">${platformName(p)}</span></div>
        <div class="pb-days">${pl.length}è¨˜éŒ²</div>
      </div>
      <div class="pb-sales">Â¥${s.toLocaleString('ja-JP')}</div>
      <div class="pb-meta">${c}ä»¶ / æ™‚çµ¦Â¥${hr.toLocaleString('ja-JP')}</div>
    </div>`;
  }).filter(Boolean);
  el.innerHTML = cards.length ? cards.join('') : '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI ADVICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function getAIAdvice(){
  const today = getTodayKey();
  let logs = getLogs().filter(l=>l.date===today);
  if(_reportFilter!=='all') logs=logs.filter(l=>(l.platform||'uber')===_reportFilter);
  if(!logs.length){ showToast('âš ï¸ ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“','#ff5252'); return; }

  const sales  = logs.reduce((s,l)=>s+l.sales,0);
  const count  = logs.reduce((s,l)=>s+l.count,0);
  const dist   = logs.reduce((s,l)=>s+l.dist, 0);
  const hours  = logs.reduce((s,l)=>s+l.hours,0);
  const hourly = hours>0?Math.round(sales/hours):0;
  const kmprice= dist>0?Math.round(sales/dist):0;
  const unit   = count>0?Math.round(sales/count):0;
  const pName  = _reportFilter==='all'?'ãƒ•ãƒ¼ãƒ‰ãƒ‡ãƒªãƒãƒªãƒ¼':platformName(_reportFilter);

  document.getElementById('advice-list').innerHTML='';
  document.getElementById('ai-thinking').classList.add('show');

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:700,
        messages:[{role:'user',content:`ã‚ãªãŸã¯${pName}é…é”å“¡ã®ã‚³ãƒ¼ãƒã§ã™ã€‚ä»¥ä¸‹ã®æœ¬æ—¥ã®æˆç¸¾ã‚’åˆ†æã—ã¦ã€å®Ÿç”¨çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’3ã€œ4å€‹ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
æˆç¸¾ï¼šãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ =${pName}ã€å£²ä¸ŠÂ¥${sales}ã€ä»¶æ•°${count}ä»¶ã€è·é›¢${dist}kmã€ç¨¼åƒæ™‚é–“${hours}hã€æ™‚çµ¦Â¥${hourly}ã€è·é›¢åŠ¹ç‡Â¥${kmprice}/kmã€ä»¶å˜ä¾¡Â¥${unit}
ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§è¿”ã—ã¦ãã ã•ã„ï¼š
[{"icon":"çµµæ–‡å­—","type":"good|warn|tip","text":"ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ–‡ï¼ˆ60å­—ä»¥å†…ï¼‰"}]`
        }]
      })
    });
    const data = await response.json();
    const text = data.content.map(c=>c.text||'').join('');
    const clean= text.replace(/```json|```/g,'').trim();
    renderAdvices(JSON.parse(clean));
  } catch(e) {
    renderAdvices(generateRuleAdvice(hourly,kmprice,unit,count,_reportFilter));
  }
  document.getElementById('ai-thinking').classList.remove('show');
}

function generateRuleAdvice(hourly,kmprice,unit,count,platform){
  const a=[];
  if(hourly>=3000) a.push({icon:'âœ…',type:'good',text:'æ™‚çµ¦ã¯è‰¯å¥½ã§ã™ï¼ã“ã®åŠ¹ç‡ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚'});
  else a.push({icon:'ğŸ’¡',type:'tip',text:'æ™‚çµ¦ã‚¢ãƒƒãƒ—ã«ã¯æ˜¼ãƒ»å¤•æ–¹ã®ãƒ”ãƒ¼ã‚¯æ™‚é–“ã®æ´»ç”¨ãŒåŠ¹æœçš„ã§ã™ã€‚'});
  if(count<5) a.push({icon:'âš ï¸',type:'warn',text:'ä»¶æ•°ã‚’å¢—ã‚„ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚è¿‘è·é›¢ã®ä¾é ¼ã‚’å„ªå…ˆã™ã‚‹ã¨åŠ¹ç‡UPï¼'});
  if(kmprice<150) a.push({icon:'âš ï¸',type:'warn',text:'è·é›¢åŠ¹ç‡ãŒä½ã‚ã§ã™ã€‚è¿‘è·é›¢ã®é…é”ã‚’å„ªå…ˆã—ã€ç§»å‹•è·é›¢ã‚’æŠ‘ãˆã¾ã—ã‚‡ã†ã€‚'});
  else a.push({icon:'âœ…',type:'good',text:'è·é›¢åŠ¹ç‡ã¯è‰¯å¥½ã§ã™ï¼å¼•ãç¶šãè¿‘è·é›¢é‡è¦–ã§ç¨¼ãã¾ã—ã‚‡ã†ã€‚'});
  if(platform==='rocketnow') a.push({icon:'ğŸŸ ',type:'tip',text:'RocketNowã®ãƒ–ãƒ¼ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚’ç‹™ã†ã¨ä»¶å˜ä¾¡ãŒã•ã‚‰ã«UPã—ã¾ã™ã€‚'});
  else a.push({icon:'ğŸŸ¢',type:'tip',text:'Uber Eatsã®ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“å¸¯ã‚’æ´»ç”¨ã™ã‚‹ã¨åå…¥ãŒä¼¸ã³ã¾ã™ã€‚'});
  return a;
}

function renderAdvices(advices){
  const icons={good:'âœ…',warn:'âš ï¸',tip:'ğŸ’¡'};
  document.getElementById('advice-list').innerHTML=advices.map(a=>`
    <div class="advice-item">
      <span class="advice-icon">${a.icon||icons[a.type]||'ğŸ’¡'}</span>
      <span>${a.text}</span>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MANUAL INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openManualModal(){
  document.getElementById('m-platform').value = currentPlatform;
  document.getElementById('manual-modal').classList.add('open');
}
function closeManualModal(){
  document.getElementById('manual-modal').classList.remove('open');
}
function saveManual(){
  const date     = document.getElementById('m-date').value;
  const platform = document.getElementById('m-platform').value;
  const sales    = parseFloat(document.getElementById('m-sales').value)||0;
  const count    = parseInt(document.getElementById('m-count').value)||0;
  const dist     = parseFloat(document.getElementById('m-dist').value)||0;
  const hours    = parseFloat(document.getElementById('m-hours').value)||0;
  if(!date||!sales||!count){ showToast('âš ï¸ æ—¥ä»˜ãƒ»å£²ä¸Šãƒ»ä»¶æ•°ã¯å¿…é ˆã§ã™','#ff5252'); return; }
  const log = buildLog(date,sales,count,dist,hours,platform);
 
  const logs = getLogs(); logs.push(log); saveLogs(logs);
  closeManualModal();
  ['m-sales','m-count','m-dist','m-hours'].forEach(id=>document.getElementById(id).value='');
  updateHomeStats(); renderHistory(); renderReport();
  showToast(`âœ… ${platformName(platform)}ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS & UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab){
  ['home','history','report','rankings','settings'].forEach(t=>{
    document.getElementById('page-'+t).classList.toggle('active',t===tab);
    const nb=document.getElementById('nav-'+t);
    if(nb) nb.classList.toggle('active',t===tab);
  });
  if(tab==='history')  renderHistory();
  if(tab==='report')   renderReport();
}

function toggleAutoSave(){
  autoSave=!autoSave;
  document.getElementById('auto-save-toggle').classList.toggle('on',autoSave);
}

function platformName(p){
  return p==='rocketnow' ? 'RocketNow' : 'Uber Eats';
}
function platformBadgeClass(p){
  return p==='rocketnow' ? 'badge-rocket' : 'badge-uber';
}
function fmtDate(d){
  const dt=new Date(d+'T00:00:00');
  const days=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  return `${dt.getMonth()+1}/${dt.getDate()}ï¼ˆ${days[dt.getDay()]}ï¼‰`;
}

function trackIncomeCta(type){
  const labels = {
    rocketnow:       'RocketNowç™»éŒ²',
    uber:            'Uber Eatsç™»éŒ²',
    tips_nyafu:      'å‰¯æ¥­Tipsï¼ˆã«ã‚ƒãµã€œï¼‰',
    tips_kumasanpo:  'å‰¯æ¥­Tipsï¼ˆãã¾ã•ã‚“ã½ï¼‰',
  };
  console.log('[income_support_click]', { type, label: labels[type]||type, ts: new Date().toISOString() });
}

function clearAllData(){
  if(!confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return;
  localStorage.removeItem('dc_logs');
  updateHomeStats(); renderHistory(); renderReport();
  showToast('ğŸ—‘ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ','#ff5252');
}

function showLoading(msg='è§£æä¸­...'){
  document.getElementById('loading-text').textContent=msg;
  document.getElementById('loading').classList.add('show');
}
function hideLoading(){
  document.getElementById('loading').classList.remove('show');
}
function showToast(msg,color='var(--accent)'){
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.background=color;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2400);
}

// Stub functions for ranking/auth (not used in offline version)
function loginWithGoogle(){ showToast('âš ï¸ Firebaseæœªè¨­å®šã§ã™','#ffc107'); }
function logout(){}
function setRankType(){}
</script>
</body>
</html>
